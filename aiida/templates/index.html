<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>AiiDA Workflow Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>
    <header class="container d-flex align-items-center mb-4">
        <img src="static/logo-light.svg" alt="Logo" style="height: 50px; margin-right: 10px;">
        <h1 class="mb-0">Workflow Manager</h1>
    </header>

    <hr>

    <div class="container mt-5">
        <div class="row">
            <div class="col-8">
                <h1>RO-Crate Exporter</h1>
                <div class="mb-3">
                    <h2>Upload files to include in your RO-Crate</h2>
                    <form id="uploadForm" enctype="multipart/form-data">
                        <input type="file" name="file" class="form-control">
                        <input type="text" name="type" placeholder="Enter type (e.g., Dataset, Image)"
                            class="form-control my-2">
                        <button type="button" onclick="uploadFile()" class="btn btn-primary">Upload</button>
                    </form>
                </div>
                <div>
                    <h5>Uploaded Files</h5>
                    <ul id="fileList" class="list-group"></ul>
                </div>
            </div>
            <div class="col-4">
                <div class="container mt-5">
                    <h4>Export RO-Crate and Download</h4>
                    <button onclick="exportData()" type="button" class="btn btn-primary">Prepare RO-Crate</button>
                    <a id="downloadLink" href="/download" style="display: none;">Download RO-Crate</a>
                </div>
            </div>
        </div>

    </div>

    <script>
        window.onload = function () {
            fetch('/files')
                .then(response => response.json())
                .then(data => {
                    const fileList = document.getElementById('fileList');
                    data.forEach(file => {
                        const li = document.createElement('li');
                        li.textContent = file.filename + ' (' + file.type + ')';
                        li.className = 'list-group-item';
                        fileList.appendChild(li);
                    });
                });
        };

        function uploadFile() {
            var form = document.getElementById('uploadForm');
            var formData = new FormData(form);
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/upload', true);
            xhr.onload = function () {
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    var fileList = document.getElementById('fileList');
                    var li = document.createElement('li');
                    li.textContent = response.filename + ' (' + response.type + ')';
                    li.className = 'list-group-item';
                    fileList.appendChild(li);
                } else {
                    alert('File upload failed!');
                }
            };
            xhr.send(formData);
        }

        function exportData() {
            fetch('/export')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('downloadLink').style.display = 'block';
                })
                .catch(error => console.error('Error:', error));
        }
    </script>

    <hr>

    <div class="container mt-5">
        <div id="loading" class="text-center my-3" style="display: none;">Loading...</div>
        <div id="error" class="alert alert-danger mt-3" style="display: none;"></div>
        <div class="col-12">
            <h1 class="mb-4">AiiDA Data Viewer</h1>
            <div class="mb-3">
                <h2>Filter by Type</h2>
                <div class="mb-3 d-flex align-items-center">
                    <button onclick="fetchFilteredData()" class="btn btn-success">Filter</button>
                    <select id="typeSelect" class="form-select"></select>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped mt-3" id="dataTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Type</th>
                            <th>Title</th>
                            <th>Ontology</th>
                            <th>Metadata</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data rows will be appended here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="col-12">
            <h1 class="mb-4">Connect to openBIS</h1>
            <div class="mb-3">
                <button onclick="fetchOpenbisData()" class="btn btn-primary">Fetch openBIS Ontologies</button>
            </div>
            <div id="openbisSteps" class="mb-3"></div>

            <div id="filterSection" class="mb-3 d-none align-items-center">

                <h2>Filter OpenBIS Ontology: </h2>
                <div class="mb-3 d-flex align-items-center">
                    <select id="openbisTypeSelect" class="form-select me-2">
                        <option value="">Select an Ontology</option>
                    </select>
                    <button onclick="fetchFilteredOpenbisData()" class="btn btn-success">Fetch from OpenBIS</button>
                </div>
            </div>
            <ul id="openbisDataList" class="list-group mt-3"></ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
        });

        function toggleLoading(isLoading) {
            const loadingElement = document.getElementById('loading');
            loadingElement.style.display = isLoading ? 'block' : 'none';
        }

        function handleError(message) {
            const errorElement = document.getElementById('error');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            toggleLoading(false);
        }

        function hideError() {
            const errorElement = document.getElementById('error');
            errorElement.style.display = 'none';
        }

        function fetchData() {
            toggleLoading(true);
            fetch('/data')
                .then(response => response.json())
                .then(data => {
                    updateList(data);
                    populateTypes(data);
                    populateSelectSimulation(data);
                    toggleLoading(false);
                })
                .catch(error => handleError('Failed to fetch data.'));
        }

        function populateTypes(data) {
            const types = new Set(data.map(item => item.type));
            const typeSelect = document.getElementById('typeSelect');
            typeSelect.innerHTML = '<option value="">All</option>';
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });
        }

        function fetchFilteredData() {
            const selectedType = document.getElementById('typeSelect').value;
            if (selectedType) {
                toggleLoading(true);
                fetch(`/data/filter?type=${encodeURIComponent(selectedType)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            updateList(data);
                            hideError();
                        } else {
                            handleError('No data found for the selected type.');
                        }
                        toggleLoading(false);
                    })
                    .catch(error => handleError('Failed to fetch filtered data.'));
            } else {
                fetchData();
            }
        }

        function updateList(data) {
            const tableBody = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            data.forEach(item => {
                const row = tableBody.insertRow();
                const cellId = row.insertCell(0);
                const cellType = row.insertCell(1);
                const cellTitle = row.insertCell(2);
                const cellOnt = row.insertCell(3);
                const cellMetadata = row.insertCell(4);
                cellId.textContent = item.id;
                cellType.textContent = item.type;
                cellTitle.textContent = item.title;
                cellOnt.textContent = item.ontology;
                cellMetadata.textContent = JSON.stringify(item.metadata);
            });
        }

        function fetchOpenbisData() {
            toggleLoading(true);
            updateSteps("Fetching data from openBIS...");

            fetch('http://localhost:5001/data/types', {
                method: 'GET',
                headers: {
                    'Accept': 'application/zip',
                }
            })
                .then(response => {
                    if (response.ok) {
                        updateSteps("Data fetched successfully. Unzipping file...");
                        return response.blob();
                    }
                    throw new Error('Network response was not ok.');
                })
                .then(blob => {
                    const jsZip = new JSZip();
                    return jsZip.loadAsync(blob);
                })
                .then(zip => {
                    updateSteps("Zip file unzipped. Listing files...");
                    updateSteps(JSON.stringify(Object.keys(zip.files)));
                    const filename = 'response.json';
                    if (filename in zip.files) {
                        return zip.files[filename].async("string");
                    }
                    throw new Error('File not found in zip');
                })
                .then(jsonString => {
                    updateSteps("JSON extracted. Parsing data...");
                    const data = JSON.parse(jsonString);
                    updateTypeSelection(data);
                    updateSteps("Data parsed and UI updated.");
                    toggleLoading(false);
                    showFilterSection();
                })
                .catch(error => {
                    handleError('Failed to fetch or process data.');
                    updateSteps("Error occurred.");
                });
        }

        function updateTypeSelection(data) {
            const openbisTypes = new Set(data);
            const openbisTypeSelect = document.getElementById('openbisTypeSelect');
            openbisTypeSelect.innerHTML = '<option value="">Select a type</option>';
            openbisTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                openbisTypeSelect.appendChild(option);
            });
        }

        function fetchFilteredOpenbisData() {
            const selectedType = document.getElementById('openbisTypeSelect').value;
            if (selectedType) {
                toggleLoading(true);
                updateSteps("Fetching filtered data for type: " + selectedType);
                fetch(`http://localhost:5001/data/filter?type=${encodeURIComponent(selectedType)}&format=ROC`)
                    .then(response => response.json())
                    .then(data => {
                        updateOpenbisList(data);
                        updateSteps("Filtered data fetched and displayed.");
                        toggleLoading(false);
                    })
                    .catch(error => {
                        handleError('Failed to fetch filtered data.');
                        updateSteps("Error occurred while fetching filtered data.");
                    });
            } else {
                alert('Please select a type to filter by!');
            }
        }

        function importData(item) {
            fetch('data/import', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(item)
            })
                .then(response => {
                    if (response.ok) {
                        alert(`Data for item ID: ${item.id} has been successfully imported.`);
                    } else {
                        throw new Error('Failed to import data.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while importing data.');
                });
        }

        function updateOpenbisList(data) {
            const list = document.getElementById('openbisDataList');
            list.innerHTML = '';
            data.forEach(item => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
            <span>
                <strong>ID:</strong> ${item.id} 
                <strong>Ontology:</strong> ${item.ontology} 
            </span>
            <button class="btn btn-outline-secondary btn-sm" onclick='importData(${JSON.stringify(item)})'>Import Data</button>
        `;
                list.appendChild(li);
            });
        }

        function updateSteps(message) {
            const stepsElement = document.getElementById('openbisSteps');
            const step = document.createElement('div');
            step.textContent = message;
            stepsElement.appendChild(step);
        }

        function showFilterSection() {
            const filterSection = document.getElementById('filterSection');
            filterSection.classList.remove('d-none');
            filterSection.classList.add('d-flex');
        }

    </script>

    <hr>

    <div class="container">
        <h1 class="mb-4">Run Simulations</h1>
        <div class="col-12">
            <h3>Select an Object</h3>
            <div class="mt-4 d-flex align-items-center">
                <select id="objectSelect" class="form-select mb-3">
                    <option value="">Select an Object</option>
                </select>
                <button onclick="startSimulation()" class="btn btn-warning">Start Simulation</button>
            </div>
        </div>
        <div id="sim_message" class="alert alert-success d-none"></div>

    </div>


    <script>
        // Function to start the simulation process
        function populateSelectSimulation(data) {
            const objectsList = data.filter(item => item.type !== "@aiida.Simulation" && item.type !== "@aiida.Workflow");
            const objectSelect = document.getElementById('objectSelect');
            objectSelect.innerHTML = '<option value="">Select an Object</option>';
            objectsList.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id; // Store item as a string in the value
                option.textContent = item.id + " - " + item.title;
                objectSelect.appendChild(option);
            });
        }

        function startSimulation() {
            const selectedObjectId = document.getElementById('objectSelect').value;

            if (!selectedObjectId) {
                alert('Please select an object to link with the simulation.');
                return;
            }

            fetch(`/data/start_simulation?id=${encodeURIComponent(selectedObjectId)}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Failed to start simulation.');
                    }
                })
                .then(response => displayNewObject(response))
                .catch(error => {
                    handleError('Failed to fetch or process data.');
                });
        }

        function displayNewObject(newObject) {
            const displayArea = document.getElementById('sim_message');
            displayArea.classList.remove('d-none');
            displayArea.textContent = "Updated Object with new simulation: " + JSON.stringify(newObject, null, 2);

            // Create the Export to openBIS button if it does not exist
            let exportButton = document.getElementById('exportToOpenBIS');
            if (!exportButton) {
                exportButton = document.createElement('button');
                exportButton.id = 'exportToOpenBIS';
                exportButton.textContent = 'Export to openBIS';
                exportButton.className = 'btn btn-success mt-3';
                exportButton.onclick = () => exportToOpenBIS(newObject);
                displayArea.parentNode.insertBefore(exportButton, displayArea.nextSibling);
            }
        }

        // Function to create an RO-Crate and send it to another application
        function exportToOpenBIS(newObject) {
            fetch('/api/export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newObject)
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Failed to export to openBIS.');
                    }
                })
                .then(data => alert('Successfully exported to openBIS.'))
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred during the export to openBIS.');
                });
        }

    </script>

    <hr>

    <div class="container mt-5">
        <div class="col-6">
            <h1 class="mb-4">Display RO-Crate Zip File</h1>
            <form id="uploadForm1" class="mb-4">
                <input type="file" id="fileInput1" accept=".zip" class="form-control mb-2">
                <button type="button" onclick="uploadRocrate()" class="btn btn-primary">Upload</button>
            </form>
            <h2>Results:</h2>
            <pre id="result1" class="bg-light p-3 border"></pre>
        </div>
    </div>

    <script>
        function uploadRocrate() {
            const formData = new FormData();
            const fileInput = document.getElementById('fileInput1');
            const resultDiv = document.getElementById('result1');

            if (fileInput.files.length > 0) {
                formData.append('file', fileInput.files[0]);

                fetch('/upload_rocrate', {
                    method: 'POST',
                    body: formData,
                })
                    .then(response => response.json())
                    .then(data => {
                        resultDiv.textContent = JSON.stringify(data, null, 2);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        resultDiv.textContent = 'Failed to upload and process the file.';
                    });
            } else {
                resultDiv.textContent = 'Please select a file to upload.';
            }
        }
    </script>
</body>

</html>
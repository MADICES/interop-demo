<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>OpenBIS ELN/LIMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>
    <hr>
    <div class="container mt-5">
        <div class="row">
            <div class="col-6">
                <h1 class="mb-4">OpenBIS Data Viewer</h1>
                <div class="mb-3">
                    <button onclick="fetchData()" class="btn btn-primary">Fetch Data</button>
                </div>
                <div class="mb-3">
                    <h2>Filter by Type</h2>
                    <select id="typeSelect" class="form-select mb-3">
                        <option value="">Select a type</option>
                    </select>
                    <button onclick="fetchFilteredData()" class="btn btn-success">Fetch Filtered Data</button>
                </div>
                <ul id="dataList" class="list-group mt-3"></ul>
            </div>
            <div class="col-6">
                <h1 class="mb-4">Connect to AiiDA</h1>
                <div class="mb-3">
                    <button onclick="fetchAIDAData()" class="btn btn-primary">Fetch AiiDA types</button>
                </div>
                <div id="aidatypes" class="mb-3">

                </div>
                <div class="mb-3">
                    <h2>Filter by AiiDA Type</h2>
                    <select id="aidatypeSelect" class="form-select mb-3">
                        <option value="">Select a type</option>
                    </select>
                    <button onclick="fetchFilteredAidaData()" class="btn btn-success">Fetch Filtered AiiDA Data</button>
                </div>
                <ul id="aidadataList" class="list-group mt-3"></ul>
            </div>
        </div>
    </div>

    <script>
        function fetchAIDAData() {
            fetch('http://localhost:5002/data/types', {
                method: 'GET',
                headers: {
                    'Accept': 'application/zip',
                }
            })
                .then(response => {
                    if (response.ok) return response.blob();
                    throw new Error('Network response was not ok.');
                })
                .then(blob => {
                    // Use JSZip to read the blob as a zip file
                    const jsZip = new JSZip();
                    return jsZip.loadAsync(blob);
                })
                .then(zip => {
                    // Assume 'response.json' is the name of the file inside the RO-Crate zip
                    const filename = 'response.json';
                    if (filename in zip.files) {
                        return zip.files[filename].async("string"); // Get the file content as a string
                    }
                    throw new Error('File not found in zip');
                })
                .then(jsonString => {
                    // Parse JSON string and log the data or do something with it
                    const data = JSON.parse(jsonString);
                    console.log(data);
                    // Optionally update the UI here to display the data
                    const aidatypes = new Set(data);
                    const aidatypeSelect = document.getElementById('aidatypeSelect');
                    aidatypeSelect.innerHTML = '<option value="">Select a type</option>'; // Reset
                    aidatypes.forEach(type => {
                        console.log(type);
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        aidatypeSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error:', error));
        }

        function fetchFilteredAidaData() {
            var selectedType = document.getElementById('aidatypeSelect').value;
            if (selectedType) {
                fetch(`http://localhost:5002/data/filter?type=${encodeURIComponent(selectedType)}`)
                    .then(response => response.json())
                    .then(data => updateAidaList(data))
                    .catch(error => console.error('Error:', error));
            } else {
                alert('Please select a type to filter by!');
            }
        }

        function updateAidaList(data) {
            const list = document.getElementById('aidadataList');
            list.innerHTML = ''; // Clear previous entries
            data.forEach(item => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = `ID: ${item.id}, Type: ${item.type}`;
                list.appendChild(li);
            });
        }

        function fetchData() {
            fetch('/data')
                .then(response => response.json())
                .then(data => {
                    updateList(data);
                    populateTypes(data);
                })
                .catch(error => console.error('Error:', error));
        }

        function populateTypes(data) {
            const types = new Set(data.map(item => item.type));
            const typeSelect = document.getElementById('typeSelect');
            typeSelect.innerHTML = '<option value="">Select a type</option>'; // Reset
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });
        }

        function fetchFilteredData() {
            var selectedType = document.getElementById('typeSelect').value;
            if (selectedType) {
                fetch(`/data/filter?type=${encodeURIComponent(selectedType)}`)
                    .then(response => response.json())
                    .then(data => updateList(data))
                    .catch(error => console.error('Error:', error));
            } else {
                alert('Please select a type to filter by!');
            }
        }

        function updateList(data) {
            const list = document.getElementById('dataList');
            list.innerHTML = ''; // Clear previous entries
            data.forEach(item => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = `ID: ${item.id}, Type: ${item.type}, Title: ${item.title}`;
                list.appendChild(li);
            });
        }
    </script>

    <hr>
    <div class="container mt-5">
        <h1>RO-Crate Exporter</h1>
        <div class="mb-3">
            <h2>Upload files to include in your RO-Crate</h2>
            <form id="uploadForm" enctype="multipart/form-data">
                <input type="file" name="file" class="form-control">
                <input type="text" name="type" placeholder="Enter type (e.g., Dataset, Image)"
                    class="form-control my-2">
                <button type="button" onclick="uploadFile()" class="btn btn-primary">Upload</button>
            </form>
        </div>
        <div>
            <h5>Uploaded Files</h5>
            <ul id="fileList" class="list-group"></ul>
        </div>
    </div>

    <script>
        window.onload = function () {
            fetch('/files')
                .then(response => response.json())
                .then(data => {
                    const fileList = document.getElementById('fileList');
                    data.forEach(file => {
                        const li = document.createElement('li');
                        li.textContent = file.filename + ' (' + file.type + ')';
                        li.className = 'list-group-item';
                        fileList.appendChild(li);
                    });
                });
        };

        function uploadFile() {
            var form = document.getElementById('uploadForm');
            var formData = new FormData(form);
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/upload', true);
            xhr.onload = function () {
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    var fileList = document.getElementById('fileList');
                    var li = document.createElement('li');
                    li.textContent = response.filename + ' (' + response.type + ')';
                    li.className = 'list-group-item';
                    fileList.appendChild(li);
                } else {
                    alert('File upload failed!');
                }
            };
            xhr.send(formData);
        }
    </script>

    <div class="container mt-5">
        <h4>Export RO-Crate and Download</h4>
        <button onclick="exportData()" type="button" class="btn btn-primary">Prepare RO-Crate</button>
        <a id="downloadLink" href="/download" style="display: none;">Download RO-Crate</a>
    </div>
    <script>
        function exportData() {
            fetch('/export')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('downloadLink').style.display = 'block';
                })
                .catch(error => console.error('Error:', error));
        }
    </script>

    <hr>
    
    <div class="container mt-5">
        <h1 class="mb-4">Upload RO-Crate Zip File</h1>
        <form id="uploadForm1" class="mb-4">
            <input type="file" id="fileInput1" accept=".zip" class="form-control mb-2">
            <button type="button" onclick="uploadRocrate()" class="btn btn-primary">Upload</button>
        </form>
        <h2>Results:</h2>
        <pre id="result1" class="bg-light p-3 border"></pre>
    </div>

    <script>
        function uploadRocrate() {
            const formData = new FormData();
            const fileInput = document.getElementById('fileInput1');
            const resultDiv = document.getElementById('result1');

            if (fileInput.files.length > 0) {
                formData.append('file', fileInput.files[0]);

                fetch('/upload_rocrate', {
                    method: 'POST',
                    body: formData,
                })
                    .then(response => response.json())
                    .then(data => {
                        resultDiv.textContent = JSON.stringify(data, null, 2);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        resultDiv.textContent = 'Failed to upload and process the file.';
                    });
            } else {
                resultDiv.textContent = 'Please select a file to upload.';
            }
        }
    </script>
</body>

</html>